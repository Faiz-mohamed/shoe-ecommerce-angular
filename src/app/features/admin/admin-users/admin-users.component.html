<section class="admin-users-page">
  <header class="page-header">
    <div>
      <h1>User Management</h1>
      <p class="sub">Overview of users and quick actions</p>
    </div>
    <div class="header-actions">
      <!-- future: search, filters -->
      <button class="btn small ghost" aria-label="Add user">+ Add user</button>
    </div>
  </header>

  <!-- Stats -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-title">Total Users</div>
      <div class="stat-value">{{ totalUsers }}</div>
    </div>

    <div class="stat-card">
      <div class="stat-title">Online</div>
      <div class="stat-value">{{ onlineUsers }}</div>
    </div>

    <div class="stat-card">
      <div class="stat-title">Offline</div>
      <div class="stat-value">{{ offlineUsers }}</div>
    </div>
  </div>

  <!-- Users list / table -->
  <div class="users-table-wrapper">
    <!-- Desktop table -->
    <table class="users-table" role="table" aria-label="Users table">
      <thead>
        <tr>
          <th>User ID</th>
          <th>Email</th>
          <th>Status</th>
          <th>Orders</th>
          <th class="col-actions">Actions</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let user of users; trackBy: trackByUserId">
          <td class="mono cell-id" title="{{ user.id }}">{{ user.id }}</td>

          <!-- Email column: allow ellipsis but stable width -->
          <td class="cell-email">
            <div class="email-wrap">
              <div class="email">{{ user.email }}</div>
            </div>
          </td>

          <!-- Status -->
          <td class="cell-status">
            <span class="badge" [ngClass]="{ 'active': user.active, 'inactive': !user.active }" title="{{ user.active ? 'Active' : 'Inactive' }}">
              {{ user.active ? 'Active' : 'Inactive' }}
            </span>
            <span class="dot" [title]="user.online ? 'Online' : 'Offline'" [class.online]="user.online"></span>
          </td>

          <!-- Orders count -->
          <td class="cell-orders">
            <button class="link-btn" (click)="openOrdersModal(user); $event.stopPropagation()">View ({{ user.orders.length }})</button>
          </td>

          <!-- Actions: three icon buttons -->
          <td class="col-actions cell-actions">
            <div class="actions-group" role="group" aria-label="User actions">
              <!-- Suspend / Unsuspend -->
              <button
                class="icon-btn action-suspend"
                [class.suspended]="!user.active"
                (click)="toggleSuspend(user); $event.stopPropagation()"
                [attr.aria-pressed]="!user.active"
                [attr.title]="user.active ? 'Suspend user' : 'Unsuspend user'">
                <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                  <path fill="currentColor" d="M12 12a4 4 0 100-8 4 4 0 000 8zm0 2c-4.418 0-8 2.239-8 5v1h16v-1c0-2.761-3.582-5-8-5z"/>
                </svg>
                <span class="tooltip">{{ user.active ? 'Suspend user' : 'Unsuspend user' }}</span>
              </button>

              <!-- View Orders -->
              <button
                class="icon-btn action-orders"
                (click)="openOrdersModal(user); $event.stopPropagation()"
                aria-label="View orders"
                title="View orders">
                <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                  <path fill="currentColor" d="M21 8l-9-4-9 4v8a2 2 0 002 2h14a2 2 0 002-2V8zM12 4.2L19 8l-7 3.6L5 8l7-3.8z"/>
                </svg>
                <span class="tooltip">View orders</span>
              </button>

              <!-- View User -->
              <button
                class="icon-btn action-view"
                (click)="openUserModal(user); $event.stopPropagation()"
                aria-label="View user"
                title="View user">
                <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                  <path fill="currentColor" d="M12 5c-7 0-11 6-11 7s4 7 11 7 11-6 11-7-4-7-11-7zm0 12a5 5 0 110-10 5 5 0 010 10z"/>
                  <circle cx="12" cy="12" r="2.5" fill="currentColor"></circle>
                </svg>
                <span class="tooltip">View user</span>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Mobile card fallback (shows only on small screens via CSS) -->
    <div class="users-cards" *ngIf="users.length">
      <article class="user-card" *ngFor="let user of users; trackBy: trackByUserId">
        <div class="card-top">
          <div>
            <div class="mono">{{ user.id }}</div>
            <div class="email">{{ user.email }}</div>
          </div>
          <div class="right">
            <span class="badge" [ngClass]="{ 'active': user.active, 'inactive': !user.active }">{{ user.active ? 'Active' : 'Inactive' }}</span>
            <div class="dot" [class.online]="user.online" title="{{ user.online ? 'Online' : 'Offline' }}"></div>
          </div>
        </div>

        <div class="card-bottom">
          <div class="orders-count">Orders: <strong>{{ user.orders.length }}</strong></div>
          <div class="card-actions">
            <!-- mobile actions: same three icons, compact -->
            <button class="icon-btn action-suspend" [class.suspended]="!user.active" (click)="toggleSuspend(user); $event.stopPropagation()" [attr.title]="user.active ? 'Suspend user' : 'Unsuspend user'">
              <svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true"><path fill="currentColor" d="M12 12a4 4 0 100-8 4 4 0 000 8zm0 2c-4.418 0-8 2.239-8 5v1h16v-1c0-2.761-3.582-5-8-5z"/></svg>
            </button>

            <button class="icon-btn action-orders" (click)="openOrdersModal(user); $event.stopPropagation()" title="View orders">
              <svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true"><path fill="currentColor" d="M21 8l-9-4-9 4v8a2 2 0 002 2h14a2 2 0 002-2V8zM12 4.2L19 8l-7 3.6L5 8l7-3.8z"/></svg>
            </button>

            <button class="icon-btn action-view" (click)="openUserModal(user); $event.stopPropagation()" title="View user">
              <svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true"><path fill="currentColor" d="M12 5c-7 0-11 6-11 7s4 7 11 7 11-6 11-7-4-7-11-7zm0 12a5 5 0 110-10 5 5 0 010 10z"/><circle cx="12" cy="12" r="2.5" fill="currentColor"></circle></svg>
            </button>
          </div>
        </div>
      </article>
    </div>
  </div>

  <!-- Orders Modal -->
  <div class="modal-backdrop" *ngIf="ordersModalOpen" (click)="closeModals()" aria-hidden="true"></div>
  <div class="modal" *ngIf="ordersModalOpen" role="dialog" aria-modal="true" aria-labelledby="orders-modal-title">
    <header class="modal-header">
      <h2 id="orders-modal-title">Orders — {{ selectedUserForOrders?.id }}</h2>
      <button class="btn ghost small" (click)="closeModals()" aria-label="Close">✕</button>
    </header>

    <div class="modal-body">
      <p class="muted">User: <strong>{{ selectedUserForOrders?.email }}</strong></p>

      <table class="orders-modal-table" *ngIf="selectedUserForOrders?.orders?.length; else noOrders">
        <thead>
          <tr>
            <th>Order</th>
            <th>Date</th>
            <th>Total</th>
            <th>Status</th>
            <th>SKU</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let o of selectedUserForOrders!.orders">
            <td class="mono">{{ o.id }}</td>
            <td>{{ o.date }}</td>
            <td>{{ formatCurrency(o.total) }}</td>
            <td><span class="status small" [ngClass]="o.status">{{ o.status }}</span></td>
            <td class="mono">{{ o.sku || '—' }}</td>
          </tr>
        </tbody>
      </table>

      <ng-template #noOrders>
        <p class="muted">No orders found for this user.</p>
      </ng-template>
    </div>

    <footer class="modal-footer">
      <button class="btn" (click)="closeModals()">Close</button>
    </footer>
  </div>

  <!-- User Details Modal -->
  <div class="modal-backdrop" *ngIf="userModalOpen" (click)="closeModals()" aria-hidden="true"></div>
  <div class="modal" *ngIf="userModalOpen" role="dialog" aria-modal="true" aria-labelledby="user-modal-title">
    <header class="modal-header">
      <h2 id="user-modal-title">User Details — {{ selectedUserForDetails?.id }}</h2>
      <button class="btn ghost small" (click)="closeModals()" aria-label="Close">✕</button>
    </header>

    <div class="modal-body">
      <dl class="user-details">
        <div>
          <dt>Email</dt>
          <dd>{{ selectedUserForDetails?.email }}</dd>
        </div>
        <div>
          <dt>Account Status</dt>
          <dd><span class="badge" [ngClass]="{ 'active': selectedUserForDetails?.active, 'inactive': !selectedUserForDetails?.active }">{{ selectedUserForDetails?.active ? 'Active' : 'Inactive' }}</span></dd>
        </div>
        <div>
          <dt>Online</dt>
          <dd>{{ selectedUserForDetails?.online ? 'Yes' : 'No' }}</dd>
        </div>
        <div>
          <dt>Created</dt>
          <dd>{{ selectedUserForDetails?.createdAt }}</dd>
        </div>
        <div>
          <dt>Orders</dt>
          <dd>{{ selectedUserForDetails?.orders?.length }}</dd>
        </div>
      </dl>

      <div class="user-actions">
        <button class="btn" (click)="toggleSuspend(selectedUserForDetails!)">{{ selectedUserForDetails?.active ? 'Suspend' : 'Unsuspend' }}</button>
        <button class="btn ghost" (click)="openOrdersModalFromDetails()">View Orders</button>
      </div>
    </div>

    <footer class="modal-footer">
      <button class="btn" (click)="closeModals()">Close</button>
    </footer>
  </div>
</section>
